# ThorSync-V2
Opens and converts ThorSync to csv and does other simple data extraction

I recommend for a typical experiment each script gets run in order of 
1 TSOutput_All.py
2 TS_Force_FrameOut.py
3 find_peaks_frames_v2.py

so that what happens is
1. You get all the channels into 1 CSV
2. You output a CSV that has only the Force and Frames into 1 small CSV
3. You analyze the Force/Frames CSV and find the on/off frames for the mechanical forces

I don't have a good method for stitching everything together as of 7/14/25.

# TSOutput_All
TSOutput_All will convert HDFs Thorsync files to CSVS.
The TS scripts will intake the .H5 files from ThorSync and downsample them to the desired rate, then filter them by whichever datafiles you want to keep, and then saving them either to a single CSV per .h5 file. 

Put all your TS files into one folder 
![image](https://github.com/cawarwick/ThorSync-Processor/assets/81972652/616452b0-2339-4836-90d1-73c130223c1d)

and provide the path in the script:
<img width="676" height="66" alt="image" src="https://github.com/user-attachments/assets/481852eb-9591-45fa-be85-9c6e6c81bce1" />

Make sure you've selected all the channels you want to keep and specified the target frame rate ('target_fs'). 100hz is fine for basic syncing, 1000hz is better for estim and mechstim, 5-10khz is minimum for frame alingment between 1p and 2p imaging. 
<img width="474" height="259" alt="image" src="https://github.com/user-attachments/assets/f2a6ba94-ccb2-41b3-9d9d-cf1b6e2b0275" />

And when run, it will generate 1 CSV per H5 file at the specified frame rate. 

# TS_Force_FrameOut.py 
uses a directory of H5s just like above except that it will only grab the Force and the Frames columns and put them into a single CSV per recording. This makes analyzing the force data faster rather than opening every column of the CSV.

I recommend leaving the frame rate at 1000hz and only changing the directory path:
<img width="666" height="59" alt="image" src="https://github.com/user-attachments/assets/cbfc534b-374b-41b1-abf5-ce3088a66eee" />

Make sure that you have the right number of frames, e.g. the 'Frames=np.divide(Frames,7)'. This is the this is the number of planes plus the number of flyback frames and your numbers will all be off if this does not match the original recording. This conversion will create a frame value which matches the TIFF volumes.
<img width="571" height="104" alt="image" src="https://github.com/user-attachments/assets/3efd1036-1e4a-4176-a1b6-4d2dd9291c70" />



# find_peaks_frames_v2
Uses the CSVs that were generated by  TS_Force_FrameOut.py. Give it the location of the CSVs that have only the force and frames
<img width="646" height="68" alt="image" src="https://github.com/user-attachments/assets/cbcbd6e2-b6ee-48cb-9ca7-6de6d58ea1c5" />

make sure you're using the right frame rate, this is expecting 1000hz.
<img width="310" height="89" alt="image" src="https://github.com/user-attachments/assets/cf444ca8-beff-42c9-b4bd-9c6417bcbb07" />

These are the detection threhsolds for events, might need to change if the stimulation is changed
<img width="643" height="76" alt="image" src="https://github.com/user-attachments/assets/4608c6d2-6b44-4ac5-826a-4cfdabbe356b" />

############################################

Some comments

mask = downsampled_data[:, selected_datasets.index("DI/2pFrames") + 1] >= 0.5

This filters the data to remove the time points that are recorded before and after the microscope is actually sacnning, e.g. Thorsync is running before and after the Scope is scanning for ~3 seconds. The Exact value will change depending on how much downsampling due to the 0's between frames being smeared, you DO NOT want to remove the zeroes between frames. At full frame rate, the scope is outputting a 1 or a 0 depending on whether it's scanning but downsampled data just looks like a 1 or a 0 with a slight smear at the transition. 
So far if you're downsampling to 10hz a value of 0.5 leaves an extra data point at the start and the end of each file, and so a value of 0.9 seems to be better. Other downsample rates have yet to be tested.
